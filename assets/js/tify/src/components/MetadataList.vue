<template>
	<div class="tify-info-metadata">
		<div
			v-for="(item, index) in metadata"
			:key="index"
		>
			<h4>
				{{ cleanLabel($store.localize(item.label)) }}
			</h4>
			<div
				ref="contents"
				class="tify-info-content"
				:class="{ '-collapsed': infoItems[index] && infoItems[index].collapsed }"
			>
				<div class="tify-info-value">
					<p
						v-if="isValidUrl(item.value)"
						:key="`url-${index}`"
					>
						<a :href="item.value">{{ item.value }}</a>
					</p>
					<p
						v-else
						:key="`html-${index}`"
						v-html="filterHtml($store.localize(item.value))"
					/>
				</div>

				<button
					v-if="infoItems[index] && infoItems[index].exceedsHeight"
					type="button"
					class="tify-info-toggle"
					@click="infoItems[index].collapsed = !infoItems[index].collapsed"
				>
					<template v-if="infoItems[index].collapsed">
						<icon-chevron-down />
						{{ $translate('Expand') }}
					</template>
					<template v-else>
						<icon-chevron-up />
						{{ $translate('Collapse') }}
					</template>
				</button>
			</div>
		</div>
	</div>
</template>

<script>
import { filterHtml } from '../modules/filter';
import { isValidUrl } from '../modules/validation';

export default {
	props: {
		metadata: {
			type: Array,
			default: () => [],
		},
	},
	data() {
		return {
			infoItems: [],
		};
	},
	watch: {
		metadata() {
			this.updateInfoItems();
		},
	},
	mounted() {
		this.updateInfoItems();
	},
	methods: {
		// TODO: Review this - maybe just display ugly strings instead
		cleanLabel(label) {
			const cleanedLabel = label.replace('_', ' ');
			return cleanedLabel.charAt(0).toUpperCase() + cleanedLabel.substr(1);
		},
		updateInfoItems() {
			this.$nextTick(() => {
				if (!this.$refs.contents) {
					return;
				}

				this.$refs.contents.forEach((content, index) => {
					const fullHeight = content.offsetHeight;

					this.infoItems[index] = {
						collapsed: true,
						exceedsHeight: true,
					};

					this.$nextTick(() => {
						const collapsedHeight = content.offsetHeight;
						const shouldBeCollapsed = fullHeight >= collapsedHeight;

						this.infoItems[index] = {
							collapsed: shouldBeCollapsed,
							exceedsHeight: shouldBeCollapsed,
						};
					});
				});
			});
		},
		filterHtml,
		isValidUrl,
	},
};
</script>
